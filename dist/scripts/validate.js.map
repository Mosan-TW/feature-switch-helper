{"version":3,"file":"validate.js","sourceRoot":"/","sources":["scripts/validate.ts"],"names":[],"mappings":"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","sourcesContent":["import 'reflect-metadata'\nimport chalk from 'chalk'\nimport * as fs from 'fs'\nimport { globbySync } from 'globby'\nimport * as path from 'path'\nimport { FeatureDefDto, FeatureSwitchConfigDto } from '../src/dto/feature-switch-config.dto.js'\nimport { Environment, FeatureSwitchHelper } from '../src/feature-switch-helper.js'\nimport { loadJsonConfig } from '../src/utils/json-config.utils.js'\n\nconsole.log(chalk.blue(`\\n=== Feature Switch Validator ===\\nProudly developed by Andrash for Havppen üòÅ\\n`))\n\nconst FEATURE_SWITCH_CONFIG_NAME = 'feature-switch.json'\nconst FEATURE_USAGE_REGEXP = /isFeatureEnabled(?:<[\\w\\-]+>)?\\(\\s*['\"`]([\\w\\-]+)['\"`]\\s*\\)/g\n\nmain()\n\nfunction main() {\n  console.log(chalk.yellow('Loading feature switch configuration...'))\n  // ËÆÄÂèñ‰∏¶Ëß£ÊûêÂäüËÉΩÈñãÈóúÈÖçÁΩÆ\n  const config = loadJsonConfig(FeatureSwitchConfigDto, FEATURE_SWITCH_CONFIG_NAME, {\n    baseDir: process.cwd(),\n    transformOption: {\n      exposeDefaultValues: true,\n    },\n  })\n  FeatureSwitchHelper.init(Environment.DEVELOPMENT, config)\n  const { features, validationOptions } = config\n  const tsFilePaths = globbySync(config.validationOptions.filePatterns, { cwd: process.cwd(), absolute: true })\n  const unusedFeatures = new Set(features.keys())\n\n  console.log(chalk.yellow(`Starting feature switch validation on ${tsFilePaths.length} TypeScript files...`))\n  let errorCount = 0\n  for (const filePath of tsFilePaths) {\n    const fileContent = fs.readFileSync(filePath, 'utf-8')\n    errorCount += validateFileContent(fileContent, filePath, config, unusedFeatures)\n  }\n  if (validationOptions.shouldUseAllDefinedFeatureSwitches) {\n    unusedFeatures.forEach(unusedFeature => {\n      console.error(chalk.red(`Error: Feature switch \"${unusedFeature}\" is defined but never used.`))\n      errorCount++\n    })\n  }\n  if (errorCount > 0) {\n    console.error(\n      chalk.red(`Feature switch validation failed with ${errorCount} error(s). Checked ${tsFilePaths.length} files.`),\n    )\n    process.exit(1)\n  } else {\n    console.log(chalk.green(`Feature switch validation passed without errors. Checked ${tsFilePaths.length} files.`))\n  }\n}\n\nfunction validateFileContent(\n  fileContent: string,\n  filePath: string,\n  config: FeatureSwitchConfigDto,\n  unusedFeatures: Set<string>,\n): number {\n  let errorCount = 0\n  const featureUsages = findFeatureUsages(fileContent, config.features)\n  const relativeFilePath = path.relative(process.cwd(), filePath)\n  // Ê™¢Êü•ÂäüËÉΩÈñãÈóú‰ΩøÁî®ÊÉÖÊ≥Å\n  for (const usage of featureUsages) {\n    if (usage.isDefined) {\n      unusedFeatures.delete(usage.featureName)\n    } else if (config.validationOptions.shouldNotUseUndefinedFeatureSwitches) {\n      console.error(\n        chalk.red(\n          `Error: Undefined feature switch \"${usage.featureName}\" used in ${relativeFilePath}:${usage.lineNumber}`,\n        ),\n      )\n      errorCount++\n    }\n  }\n  return errorCount\n}\n\ninterface FeatureUsage {\n  featureName: string\n  lineNumber: number\n  isDefined: boolean\n}\n\nfunction findFeatureUsages(content: string, features: Map<string, FeatureDefDto>): FeatureUsage[] {\n  let currentIndex = 0\n  let currentLine = 1\n  const results: FeatureUsage[] = []\n\n  const matches = Array.from(content.matchAll(FEATURE_USAGE_REGEXP))\n  // Use String.prototype.matchAll() to get an iterator of all matches\n  matches.forEach((match: RegExpMatchArray) => {\n    const featureName = match[1]\n    const matchIndex = match.index!\n    const precedingText = content.substring(currentIndex, matchIndex)\n    const lineBreakMatches = precedingText.match(/\\n/g)\n    const lineNumber = (lineBreakMatches ? lineBreakMatches.length : 0) + currentLine\n    const isDefined = features.has(featureName)\n    currentIndex = matchIndex\n    currentLine = lineNumber\n    results.push({\n      featureName,\n      lineNumber,\n      isDefined,\n    })\n  })\n\n  return results\n}\n"]}