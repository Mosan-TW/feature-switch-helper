{"version":3,"file":"feature-switch-helper.js","sourceRoot":"/","sources":["src/feature-switch-helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { FeatureDefDto } from './dto/feature-switch-config.dto.js'\nimport { FeatureSwitchConfigDto } from './dto/feature-switch-config.dto.js'\nimport { PlainObject } from './types/plain-object.js'\nimport { deepFreeze } from './utils/deep-object.utils.js'\nimport { toDto } from './utils/dto.utils.js'\n\nexport enum Environment {\n  DEVELOPMENT = 'development',\n  TEST = 'test',\n  UAT = 'uat',\n  PRODUCTION = 'production',\n}\n\nexport interface ILogger {\n  log: (message: string) => void\n}\n\nexport interface FeatureSwitchHelperOptions {\n  logger?: ILogger\n}\n\nexport class FeatureSwitchHelper {\n  private static _instance: FeatureSwitchHelper | null = null\n  private static canNew: boolean = false\n\n  /**\n   * 初始化功能開關助手\n   * @param environment 運行環境\n   * @param config 功能開關配置\n   * @param options 選項\n   */\n  static init(\n    environment: Environment,\n    config: FeatureSwitchConfigDto | PlainObject<FeatureSwitchConfigDto>,\n    options?: FeatureSwitchHelperOptions,\n  ): void {\n    if (this._instance) {\n      throw new Error('FeatureSwitchHelper has already been initialized.')\n    }\n    const configDto = config instanceof FeatureSwitchConfigDto ? config : toDto(FeatureSwitchConfigDto, config)\n    this.canNew = true\n    this._instance = new FeatureSwitchHelper(environment, configDto, options)\n    this.canNew = false\n  }\n\n  /**\n   * 檢查功能是否啟用\n   * @param featureName 功能名稱\n   * @returns 是否啟用\n   */\n  static isFeatureEnabled<T extends string>(featureName: T): boolean {\n    return this.instance.isFeatureEnabled(featureName)\n  }\n\n  /**\n   * 獲取功能開關的相關資訊\n   * @param featureName 功能名稱\n   * @returns 功能開關的相關資訊，若不存在則返回 null\n   */\n  static getFeatureDef<T extends string>(featureName: T): FeatureDefDto | null {\n    return this.instance.getFeatureDef(featureName)\n  }\n\n  private static get instance(): FeatureSwitchHelper {\n    if (!FeatureSwitchHelper._instance) {\n      throw new Error('FeatureSwitchHelper is not initialized. Please call FeatureSwitchHelper.init() first.')\n    }\n    return FeatureSwitchHelper._instance\n  }\n\n  private readonly environment: Environment\n  private readonly config: FeatureSwitchConfigDto\n  private readonly featureEnabledMap: Record<string, boolean>\n  private readonly logger: ILogger\n\n  constructor(environment: Environment, config: FeatureSwitchConfigDto, options?: FeatureSwitchHelperOptions) {\n    if (!FeatureSwitchHelper.canNew) {\n      throw new Error(\n        'FeatureSwitchHelper constructor is private. Please use FeatureSwitchHelper.init() to initialize.',\n      )\n    }\n    const { logger = console } = options || {}\n    this.environment = environment\n    this.config = deepFreeze(config)\n    this.logger = logger\n    // 建立索引，以便快速查詢功能是否啟用\n    this.featureEnabledMap = this.createFeatureEnabledMap(this.config.features)\n    // 在模組加載時記錄功能開關的使用情況\n    this.logger.log(`Current Environment: ${this.environment}`)\n    this.logFeatureSwitchUsage(this.featureEnabledMap)\n  }\n\n  /**\n   * 檢查功能是否啟用\n   * @param featureName 功能名稱\n   * @returns 是否啟用\n   */\n  private isFeatureEnabled<T extends string>(featureName: T): boolean {\n    const isEnabled = this.featureEnabledMap[featureName]\n    if (isEnabled === undefined) {\n      const message = `Feature \"${featureName}\" is not defined in 'feature-switch.json'.`\n      if (this.config.validationOptions.shouldNotUseUndefinedFeatureSwitches) {\n        throw new Error(message)\n      }\n      console.warn(message)\n      return false\n    }\n    if (isEnabled) {\n      console.log(`Feature \"${featureName}\" is used.`)\n    } else {\n      console.log(`Feature \"${featureName}\" is skipped.`)\n    }\n    return isEnabled\n  }\n\n  /**\n   * 獲取功能開關的相關資訊\n   * @param featureName 功能名稱\n   * @returns 功能開關的相關資訊，若不存在則返回 null\n   */\n  private getFeatureDef<T extends string>(featureName: T): FeatureDefDto | null {\n    return this.config.features.get(featureName) || null\n  }\n\n  private createFeatureEnabledMap(features: Map<string, FeatureDefDto>): Record<string, boolean> {\n    const map: Record<string, boolean> = {}\n    features.forEach((featureDef, featureName) => {\n      const isEnabled =\n        featureDef.isForceEnabled ||\n        (Environment.DEVELOPMENT === this.environment && featureDef.isDevFeature) ||\n        (Environment.TEST === this.environment && featureDef.isTestFeature) ||\n        (Environment.UAT === this.environment && featureDef.isUatFeature)\n\n      map[featureName] = isEnabled\n    })\n    return map\n  }\n\n  private logFeatureSwitchUsage(featureEnabledMap: Record<string, boolean>) {\n    const enabledFeatures: string[] = []\n    const disabledFeatures: string[] = []\n    for (const [featureName, isEnabled] of Object.entries(featureEnabledMap)) {\n      if (isEnabled) {\n        enabledFeatures.push(featureName)\n      } else {\n        disabledFeatures.push(featureName)\n      }\n    }\n    this.logger.log(`Enabled Features: ${JSON.stringify(enabledFeatures, null, 2)}`)\n    this.logger.log(`Disabled Features: ${JSON.stringify(disabledFeatures, null, 2)}`)\n  }\n}\n"]}